name: Build manylinux2014 aarch64 PyPI wheel

on:
  push:
    tags: v2.*
    branches: r2.9
  pull_request:
    types: [opened, synchronize, reopened]
    branches: r2.9

jobs:
  build:
    runs-on: self-hosted
    strategy:
      matrix:
        pyver: ['3.7', '3.8', '3.9', '3.10']
    steps:
    - name: Clean repository
      shell: bash
      run: find /home/ubuntu/actions-runner/_work/tensorflow/tensorflow/. -name . -o -prune -exec sudo rm -rf -- {} + || true
    - name: Checkout repository
      uses: actions/checkout@v3
    - name: Build and test pip wheel
      shell: bash
      run: |
        CI_DOCKER_BUILD_EXTRA_PARAMS='--build-arg py_major_minor_version=${{ matrix.pyver }}' \
        ./tensorflow/tools/ci_build/ci_build.sh cpu.arm64 bash tensorflow/tools/ci_build/rel/ubuntu/cpu_arm64_pip.sh
    - name: Upload pip wheel
      uses: actions/upload-artifact@v3
      with:
        name: tensorflow_${{ matrix.pyver }}_pipwheel
        path: /tensorflow/pip_test/whl/**
